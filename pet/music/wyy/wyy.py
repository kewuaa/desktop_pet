# -*- coding: utf-8 -*-
# @Author: kewuaa
# @Date:   2022-02-04 13:30:14
# @Last Modified by:   None
# @Last Modified time: 2022-03-05 09:37:07
import os
import json
import base64
import hashlib
import asyncio

from Crypto.Cipher import AES

from pet.music.musicer_model import SongInfo
from pet.music.musicer_model import SongUrl
from pet.music.musicer_model import SongID
from pet.music.musicer_model import BaseMusicer


current_path, _ = os.path.split(os.path.realpath(__file__))
spare_cookie = '_ntes_nuid=c6b62f4920356fba00bb02b9ab8ffb6e; _ntes_nnid=4fb10a59e820fa78798fdffdfa1dcbcc,1640399690494; _iuqxldmzr_=32; NMTID=00OggMHqS2StC6LaUBPh-O98krfkUoAAAF-ex-VNw; WNMCID=jdtbkl.1642743174682.01.0; WEVNSM=1.0.0; WM_TID=uWRfK7Me84ZEFBBBRUJq6C7aA7%2BSeboU; playerid=16777386; _antanalysis_s_id=1643284866993; WM_NI=KJozOm5zeeV66Qn%2F95KzDs1S%2Fk52bBUXbEnwiu9H41P9bAloma0%2BZ3dFOyDS9Gs2eO%2FdCXglj0SOLggvutt6utgHlZ8RBx4ChNyzAnaky6phoNQNY15nZhtO1VIb0x9FRk8%3D; WM_NIKE=9ca17ae2e6ffcda170e2e6ee86cb5b9496b78dd43c8def8ea7d15b938a9e84f87ba69faba4fc53ed96a9b6c72af0fea7c3b92a8996a19bce67f7a6ab86d53ef68fa2d0bc3f89a68c94b459edb5fbd3e14a9788aea6ed7dababf7a9b73b94e7aea2ef65afbf00ccd939a89a819ac759fb99bdd3e845edbc8db9e668aaf09db0cf6da5aabb95f73eb7aca9a9ef52fc8e8e99b749ac92b79bc466a3b5b7d7f364ad929fafdc3bf7b29689f745f38a8783b374fb9a9e8cbb37e2a3; JSESSIONID-WYYY=qsE2QFpkbjMDFpK6IfYNtgT%2BF5bj3WSqN1aGjCFaoOv2JQlrzq%2BAgv%2FvCisx%2FrU%5CmcnGblS7IYqnQgV2Ae9YWUARC2eUnqBkRx37Fq%2BfNo3%2Fht6bjsi5yvKwkmm%2FH0j7W8EQ4lEI8Q4Dxp6EnWmiMmx7r%2Bl1lGty%2FNSrdJq5%5C4%2Bm66f1%3A1643966110097'
CHECKTOKEN_JS = 'LyoNCiogQEF1dGhvcjoga2V3dWFhDQoqIEBEYXRlOiAgIDIwMjItMDItMTUgMDg6NTQ6MTkNCiogQExhc3QgTW9kaWZpZWQgYnk6ICAgTm9uZQ0KKiBATGFzdCBNb2RpZmllZCB0aW1lOiAyMDIyLTAzLTA1IDA5OjMzOjE0DQoqLw0KZnVuY3Rpb24gWChiKSB7DQogICAgdmFyIGMgPSBbXTsNCiAgICBjWzBdID0gQyhiID4+PiAyNCAmIDI1NSk7DQogICAgY1sxXSA9IEMoYiA+Pj4gMTYgJiAyNTUpOw0KICAgIGNbMl0gPSBDKGIgPj4+IDggJiAyNTUpOw0KICAgIGNbM10gPSBDKGIgJiAyNTUpOw0KICAgIHJldHVybiBjDQp9DQpmdW5jdGlvbiBDKGUpIHsNCiAgICBpZiAoZSA8IC0xMjgpDQogICAgICAgIHJldHVybiBDKDEyOCAtICgtMTI4IC0gZSkpOw0KICAgIGlmIChlID49IC0xMjggJiYgZSA8PSAxMjcpDQogICAgICAgIHJldHVybiBlOw0KICAgIGlmIChlID4gMTI3KQ0KICAgICAgICByZXR1cm4gQygtMTI5ICsgZSAtIDEyNyk7DQogICAgdGhyb3cgRXJyb3IoJzEwMDEnKTsNCn0NCmZ1bmN0aW9uIGdhKGUsIGMsIGQsIHIsIGcpIHsNCiAgICB2b2lkIDAgPT09IGUgJiYgKGUgPSBbXSk7DQogICAgdm9pZCAwID09PSBkICYmIChkID0gW10pOw0KICAgIGlmIChlLmxlbmd0aCkgew0KICAgICAgICBpZiAoZS5sZW5ndGggPCBnKQ0KICAgICAgICAgICAgdGhyb3cgRXJyb3IoJzEwMDMnKTsNCiAgICAgICAgZm9yICh2YXIgaCA9IDA7IGggPCBnOyBoKyspDQogICAgICAgICAgICBkW3IgKyBoXSA9IGVbYyArIGhdDQogICAgfQ0KfQ0KZnVuY3Rpb24gVWIoZSkgew0KICAgIHZhciBjID0gWw0KICAgICAgICAiMCIsDQogICAgICAgICIxIiwNCiAgICAgICAgIjIiLA0KICAgICAgICAiMyIsDQogICAgICAgICI0IiwNCiAgICAgICAgIjUiLA0KICAgICAgICAiNiIsDQogICAgICAgICI3IiwNCiAgICAgICAgIjgiLA0KICAgICAgICAiOSIsDQogICAgICAgICJhIiwNCiAgICAgICAgImIiLA0KICAgICAgICAiYyIsDQogICAgICAgICJkIiwNCiAgICAgICAgImUiLA0KICAgICAgICAiZiINCiAgICBdOw0KICAgIHJldHVybiAnJyArIGNbZSA+Pj4gNCAmIDE1XSArIGNbZSAmIDE1XQ0KfQ0KZnVuY3Rpb24gZ2IoYSkgew0KICAgIHZvaWQgMCA9PT0gYSAmJiAoYSA9IFtdKTsNCiAgICByZXR1cm4gYS5tYXAoZnVuY3Rpb24oYSkgew0KICAgICAgICByZXR1cm4gVWIoYSkNCiAgICB9KS5qb2luKCcnKQ0KfQ0KZnVuY3Rpb24gaGEoYiwgYykgew0KICAgIHZhciBkID0gKGIgJiA2NTUzNSkgKyAoYyAmIDY1NTM1KTsNCiAgICByZXR1cm4gKGIgPj4gMTYpICsgKGMgPj4gMTYpICsgKGQgPj4gMTYpIDw8IDE2IHwgZCAmIDY1NTM1DQp9DQpmdW5jdGlvbiBHKGIsIGMsIGQsIGcsIHEsIGgpIHsNCiAgICBiID0gaGEoaGEoYywgYiksIGhhKGcsIGgpKTsNCiAgICByZXR1cm4gaGEoYiA8PCBxIHwgYiA+Pj4gMzIgLSBxLCBkKQ0KfQ0KZnVuY3Rpb24gSyhhLCBiLCBkLCBnLCBxLCBoLCBtKSB7DQogICAgcmV0dXJuIEcoYiAmIGcgfCBkICYgfmcsIGEsIGIsIHEsIGgsIG0pDQp9DQpmdW5jdGlvbiBMKGEsIGIsIGQsIGcsIHEsIGgsIG0pIHsNCiAgICByZXR1cm4gRyhkIF4gKGIgfCB+ZyksIGEsIGIsIHEsIGgsIG0pDQp9DQpmdW5jdGlvbiBKKGEsIGIsIGQsIGcsIHEsIGgsIG0pIHsNCiAgICByZXR1cm4gRyhiICYgZCB8IH5iICYgZywgYSwgYiwgcSwgaCwgbSkNCn0NCmZ1bmN0aW9uIFliKGUpIHsNCiAgICB2YXIgYywgZCA9IFtdOw0KICAgIGRbKGUubGVuZ3RoID4+IDIpIC0gMV0gPSB2b2lkIDA7DQogICAgZm9yIChjID0gMDsgYyA8IGQubGVuZ3RoOyBjICs9IDEpDQogICAgICAgIGRbY10gPSAwOw0KICAgIHZhciBnID0gZS5sZW5ndGggKiA4Ow0KICAgIGZvciAoYyA9IDA7IGMgPCBnOyBjICs9IDgpDQogICAgICAgIGRbYyA+PiA1XSB8PSAoZS5jaGFyQ29kZUF0KGMgLyA4KSAmIDI1NSkgPDwgYyAlIDMyOw0KICAgIGUgPSBlLmxlbmd0aCAqIDg7DQogICAgZFtlID4+IDVdIHw9IDEyOCA8PCBlICUgMzI7DQogICAgZFsoZSArIDY0ID4+PiA5IDw8IDQpICsgMTRdID0gZTsNCiAgICB2YXIgcSwgaCwgbSA9IDE3MzI1ODQxOTMsIGYgPSAtMjcxNzMzODc5LCBsID0gLTE3MzI1ODQxOTQsIGsgPSAyNzE3MzM4Nzg7DQogICAgZm9yIChlID0gMDsgZSA8IGQubGVuZ3RoOyBlICs9IDE2KQ0KICAgICAgICBjID0gbSwNCiAgICAgICAgZyA9IGYsDQogICAgICAgIHEgPSBsLA0KICAgICAgICBoID0gaywNCiAgICAgICAgbSA9IEoobSwgZiwgbCwgaywgZFtlXSwgNywgLTY4MDg3NjkzNiksDQogICAgICAgIGsgPSBKKGssIG0sIGYsIGwsIGRbZSArIDFdLCAxMiwgLTM4OTU2NDU4NiksDQogICAgICAgIGwgPSBKKGwsIGssIG0sIGYsIGRbZSArIDJdLCAxNywgNjA2MTA1ODE5KSwNCiAgICAgICAgZiA9IEooZiwgbCwgaywgbSwgZFtlICsgM10sIDIyLCAtMTA0NDUyNTMzMCksDQogICAgICAgIG0gPSBKKG0sIGYsIGwsIGssIGRbZSArIDRdLCA3LCAtMTc2NDE4ODk3KSwNCiAgICAgICAgayA9IEooaywgbSwgZiwgbCwgZFtlICsgNV0sIDEyLCAxMjAwMDgwNDI2KSwNCiAgICAgICAgbCA9IEoobCwgaywgbSwgZiwgZFtlICsgNl0sIDE3LCAtMTQ3MzIzMTM0MSksDQogICAgICAgIGYgPSBKKGYsIGwsIGssIG0sIGRbZSArIDddLCAyMiwgLTQ1NzA1OTgzKSwNCiAgICAgICAgbSA9IEoobSwgZiwgbCwgaywgZFtlICsgOF0sIDcsIDE3NzAwMzU0MTYpLA0KICAgICAgICBrID0gSihrLCBtLCBmLCBsLCBkW2UgKyA5XSwgMTIsIC0xOTU4NDE0NDE3KSwNCiAgICAgICAgbCA9IEoobCwgaywgbSwgZiwgZFtlICsgMTBdLCAxNywgLTQyMDYzKSwNCiAgICAgICAgZiA9IEooZiwgbCwgaywgbSwgZFtlICsgMTFdLCAyMiwgLTE5OTA0MDQxNjIpLA0KICAgICAgICBtID0gSihtLCBmLCBsLCBrLCBkW2UgKyAxMl0sIDcsIDE4MDQ2MDM2ODIpLA0KICAgICAgICBrID0gSihrLCBtLCBmLCBsLCBkW2UgKyAxM10sIDEyLCAtNDAzNDExMDEpLA0KICAgICAgICBsID0gSihsLCBrLCBtLCBmLCBkW2UgKyAxNF0sIDE3LCAtMTUwMjAwMjI5MCksDQogICAgICAgIGYgPSBKKGYsIGwsIGssIG0sIGRbZSArIDE1XSwgMjIsIDEyMzY1MzUzMjkpLA0KICAgICAgICBtID0gSyhtLCBmLCBsLCBrLCBkW2UgKyAxXSwgNSwgLTE2NTc5NjUxMCksDQogICAgICAgIGsgPSBLKGssIG0sIGYsIGwsIGRbZSArIDZdLCA5LCAtMTA2OTUwMTYzMiksDQogICAgICAgIGwgPSBLKGwsIGssIG0sIGYsIGRbZSArIDExXSwgMTQsIDY0MzcxNzcxMyksDQogICAgICAgIGYgPSBLKGYsIGwsIGssIG0sIGRbZV0sIDIwLCAtMzczODk3MzAyKSwNCiAgICAgICAgbSA9IEsobSwgZiwgbCwgaywgZFtlICsgNV0sIDUsIC03MDE1NTg2OTEpLA0KICAgICAgICBrID0gSyhrLCBtLCBmLCBsLCBkW2UgKyAxMF0sIDksIDM4MDE2MDgzKSwNCiAgICAgICAgbCA9IEsobCwgaywgbSwgZiwgZFtlICsgMTVdLCAxNCwgLTY2MDQ3ODMzNSksDQogICAgICAgIGYgPSBLKGYsIGwsIGssIG0sIGRbZSArIDRdLCAyMCwgLTQwNTUzNzg0OCksDQogICAgICAgIG0gPSBLKG0sIGYsIGwsIGssIGRbZSArIDldLCA1LCA1Njg0NDY0MzgpLA0KICAgICAgICBrID0gSyhrLCBtLCBmLCBsLCBkW2UgKyAxNF0sIDksIC0xMDE5ODAzNjkwKSwNCiAgICAgICAgbCA9IEsobCwgaywgbSwgZiwgZFtlICsgM10sIDE0LCAtMTg3MzYzOTYxKSwNCiAgICAgICAgZiA9IEsoZiwgbCwgaywgbSwgZFtlICsgOF0sIDIwLCAxMTYzNTMxNTAxKSwNCiAgICAgICAgbSA9IEsobSwgZiwgbCwgaywgZFtlICsgMTNdLCA1LCAtMTQ0NDY4MTQ2NyksDQogICAgICAgIGsgPSBLKGssIG0sIGYsIGwsIGRbZSArIDJdLCA5LCAtNTE0MDM3ODQpLA0KICAgICAgICBsID0gSyhsLCBrLCBtLCBmLCBkW2UgKyA3XSwgMTQsIDE3MzUzMjg0NzMpLA0KICAgICAgICBmID0gSyhmLCBsLCBrLCBtLCBkW2UgKyAxMl0sIDIwLCAtMTkyNjYwNzczNCksDQogICAgICAgIG0gPSBHKGYgXiBsIF4gaywgbSwgZiwgZFtlICsgNV0sIDQsIC0zNzg1NTgpLA0KICAgICAgICBrID0gRyhtIF4gZiBeIGwsIGssIG0sIGRbZSArIDhdLCAxMSwgLTIwMjI1NzQ0NjMpLA0KICAgICAgICBsID0gRyhrIF4gbSBeIGYsIGwsIGssIGRbZSArIDExXSwgMTYsIDE4MzkwMzA1NjIpLA0KICAgICAgICBmID0gRyhsIF4gayBeIG0sIGYsIGwsIGRbZSArIDE0XSwgMjMsIC0zNTMwOTU1NiksDQogICAgICAgIG0gPSBHKGYgXiBsIF4gaywgbSwgZiwgZFtlICsgMV0sIDQsIC0xNTMwOTkyMDYwKSwNCiAgICAgICAgayA9IEcobSBeIGYgXiBsLCBrLCBtLCBkW2UgKyA0XSwgMTEsIDEyNzI4OTMzNTMpLA0KICAgICAgICBsID0gRyhrIF4gbSBeIGYsIGwsIGssIGRbZSArIDddLCAxNiwgLTE1NTQ5NzYzMiksDQogICAgICAgIGYgPSBHKGwgXiBrIF4gbSwgZiwgbCwgZFtlICsgMTBdLCAyMywgLTEwOTQ3MzA2NDApLA0KICAgICAgICBtID0gRyhmIF4gbCBeIGssIG0sIGYsIGRbZSArIDEzXSwgNCwgNjgxMjc5MTc0KSwNCiAgICAgICAgayA9IEcobSBeIGYgXiBsLCBrLCBtLCBkW2VdLCAxMSwgLTM1ODUzNzIyMiksDQogICAgICAgIGwgPSBHKGsgXiBtIF4gZiwgbCwgaywgZFtlICsgM10sIDE2LCAtNzIyNTIxOTc5KSwNCiAgICAgICAgZiA9IEcobCBeIGsgXiBtLCBmLCBsLCBkW2UgKyA2XSwgMjMsIDc2MDI5MTg5KSwNCiAgICAgICAgbSA9IEcoZiBeIGwgXiBrLCBtLCBmLCBkW2UgKyA5XSwgNCwgLTY0MDM2NDQ4NyksDQogICAgICAgIGsgPSBHKG0gXiBmIF4gbCwgaywgbSwgZFtlICsgMTJdLCAxMSwgLTQyMTgxNTgzNSksDQogICAgICAgIGwgPSBHKGsgXiBtIF4gZiwgbCwgaywgZFtlICsgMTVdLCAxNiwgNTMwNzQyNTIwKSwNCiAgICAgICAgZiA9IEcobCBeIGsgXiBtLCBmLCBsLCBkW2UgKyAyXSwgMjMsIC05OTUzMzg2NTEpLA0KICAgICAgICBtID0gTChtLCBmLCBsLCBrLCBkW2VdLCA2LCAtMTk4NjMwODQ0KSwNCiAgICAgICAgayA9IEwoaywgbSwgZiwgbCwgZFtlICsgN10sIDEwLCAxMTI2ODkxNDE1KSwNCiAgICAgICAgbCA9IEwobCwgaywgbSwgZiwgZFtlICsgMTRdLCAxNSwgLTE0MTYzNTQ5MDUpLA0KICAgICAgICBmID0gTChmLCBsLCBrLCBtLCBkW2UgKyA1XSwgMjEsIC01NzQzNDA1NSksDQogICAgICAgIG0gPSBMKG0sIGYsIGwsIGssIGRbZSArIDEyXSwgNiwgMTcwMDQ4NTU3MSksDQogICAgICAgIGsgPSBMKGssIG0sIGYsIGwsIGRbZSArIDNdLCAxMCwgLTE4OTQ5ODY2MDYpLA0KICAgICAgICBsID0gTChsLCBrLCBtLCBmLCBkW2UgKyAxMF0sIDE1LCAtMTA1MTUyMyksDQogICAgICAgIGYgPSBMKGYsIGwsIGssIG0sIGRbZSArIDFdLCAyMSwgLTIwNTQ5MjI3OTkpLA0KICAgICAgICBtID0gTChtLCBmLCBsLCBrLCBkW2UgKyA4XSwgNiwgMTg3MzMxMzM1OSksDQogICAgICAgIGsgPSBMKGssIG0sIGYsIGwsIGRbZSArIDE1XSwgMTAsIC0zMDYxMTc0NCksDQogICAgICAgIGwgPSBMKGwsIGssIG0sIGYsIGRbZSArIDZdLCAxNSwgLTE1NjAxOTgzODApLA0KICAgICAgICBmID0gTChmLCBsLCBrLCBtLCBkW2UgKyAxM10sIDIxLCAxMzA5MTUxNjQ5KSwNCiAgICAgICAgbSA9IEwobSwgZiwgbCwgaywgZFtlICsgNF0sIDYsIC0xNDU1MjMwNzApLA0KICAgICAgICBrID0gTChrLCBtLCBmLCBsLCBkW2UgKyAxMV0sIDEwLCAtMTEyMDIxMDM3OSksDQogICAgICAgIGwgPSBMKGwsIGssIG0sIGYsIGRbZSArIDJdLCAxNSwgNzE4Nzg3MjU5KSwNCiAgICAgICAgZiA9IEwoZiwgbCwgaywgbSwgZFtlICsgOV0sIDIxLCAtMzQzNDg1NTUxKSwNCiAgICAgICAgbSA9IGhhKG0sIGMpLA0KICAgICAgICBmID0gaGEoZiwgZyksDQogICAgICAgIGwgPSBoYShsLCBxKSwNCiAgICAgICAgayA9IGhhKGssIGgpOw0KICAgIGQgPSBbbSwgZiwgbCwga107DQogICAgYyA9ICcnOw0KICAgIGcgPSBkLmxlbmd0aCAqIDMyOw0KICAgIGZvciAoZSA9IDA7IGUgPCBnOyBlICs9IDgpDQogICAgICAgIGMgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShkW2UgPj4gNV0gPj4+IGUgJSAzMiAmIDI1NSk7DQogICAgcmV0dXJuIGMNCn0NCmZ1bmN0aW9uIFpiKGUpIHsNCiAgICB2YXIgYyA9ICcwMTIzNDU2Nzg5YWJjZGVmJywgZCA9ICcnLCBmLCBxOw0KICAgIGZvciAocSA9IDA7IHEgPCBlLmxlbmd0aDsgcSArPSAxKQ0KICAgICAgICBmID0gZS5jaGFyQ29kZUF0KHEpLA0KICAgICAgICBkICs9IGMuY2hhckF0KGYgPj4+IDQgJiAxNSkgKyBjLmNoYXJBdChmICYgMTUpOw0KICAgIHJldHVybiBkDQp9DQpmdW5jdGlvbiBoYihlKSB7DQogICAgdm9pZCAwID09PSBlICYmIChlID0gJycpOw0KICAgIGUgPSB0eXBlb2YgZSA9PT0gJ3N0cmluZycgPyBlIDogU3RyaW5nKGUpOw0KICAgIGZvciAodmFyIGMgPSBbXSwgZCA9IDAsIHIgPSAwLCBnID0gZS5sZW5ndGggLyAyOyBkIDwgZzsgZCsrKSB7DQogICAgICAgIHZhciBoID0gcGFyc2VJbnQoZS5jaGFyQXQocisrKSwgMTYpIDw8IDQNCiAgICAgICAgICAsIG0gPSBwYXJzZUludChlLmNoYXJBdChyKyspLCAxNik7DQogICAgICAgIGNbZF0gPSBDKGggKyBtKQ0KICAgIH0NCiAgICByZXR1cm4gYw0KfQ0KZnVuY3Rpb24gVGIoYSkgew0KICAgIHZvaWQgMCA9PT0gYSAmJiAoYSA9IFtdKTsNCiAgICBsZXQgU2MgPSBbDQogICAgICAgICJBIiwNCiAgICAgICAgIkIiLA0KICAgICAgICAiQyIsDQogICAgICAgICJEIiwNCiAgICAgICAgIkUiLA0KICAgICAgICAiRiIsDQogICAgICAgICJHIiwNCiAgICAgICAgIkgiLA0KICAgICAgICAiSSIsDQogICAgICAgICJKIiwNCiAgICAgICAgIksiLA0KICAgICAgICAiTCIsDQogICAgICAgICJNIiwNCiAgICAgICAgIk4iLA0KICAgICAgICAiTyIsDQogICAgICAgICJQIiwNCiAgICAgICAgIlEiLA0KICAgICAgICAiUiIsDQogICAgICAgICJTIiwNCiAgICAgICAgIlQiLA0KICAgICAgICAiVSIsDQogICAgICAgICJWIiwNCiAgICAgICAgIlciLA0KICAgICAgICAiWCIsDQogICAgICAgICJZIiwNCiAgICAgICAgIloiLA0KICAgICAgICAiYSIsDQogICAgICAgICJiIiwNCiAgICAgICAgImMiLA0KICAgICAgICAiZCIsDQogICAgICAgICJlIiwNCiAgICAgICAgImYiLA0KICAgICAgICAiZyIsDQogICAgICAgICJoIiwNCiAgICAgICAgImkiLA0KICAgICAgICAiaiIsDQogICAgICAgICJrIiwNCiAgICAgICAgImwiLA0KICAgICAgICAibSIsDQogICAgICAgICJuIiwNCiAgICAgICAgIm8iLA0KICAgICAgICAicCIsDQogICAgICAgICJxIiwNCiAgICAgICAgInIiLA0KICAgICAgICAicyIsDQogICAgICAgICJ0IiwNCiAgICAgICAgInUiLA0KICAgICAgICAidiIsDQogICAgICAgICJ3IiwNCiAgICAgICAgIngiLA0KICAgICAgICAieSIsDQogICAgICAgICJ6IiwNCiAgICAgICAgIjAiLA0KICAgICAgICAiMSIsDQogICAgICAgICIyIiwNCiAgICAgICAgIjMiLA0KICAgICAgICAiNCIsDQogICAgICAgICI1IiwNCiAgICAgICAgIjYiLA0KICAgICAgICAiNyIsDQogICAgICAgICI4IiwNCiAgICAgICAgIjkiLA0KICAgICAgICAiKyIsDQogICAgICAgICIvIg0KICAgIF0NCiAgICByZXR1cm4gU2IoYSwgU2MsICI9IikNCn0NCmZ1bmN0aW9uIFFiKGUsIGMsIGQsIHIsIGcpIHsNCiAgICB2b2lkIDAgPT09IGQgJiYgKGQgPSAwKTsNCiAgICB2b2lkIDAgPT09IHIgJiYgKHIgPSBSYik7DQogICAgdm9pZCAwID09PSBnICYmIChnID0gZGIpOw0KICAgIHZhciBoLCBtID0gW107DQogICAgc3dpdGNoIChkKSB7DQogICAgY2FzZSAxOg0KICAgICAgICBkID0gZVtjXTsNCiAgICAgICAgaCA9IDA7DQogICAgICAgIG0ucHVzaChyW2QgPj4+IDIgJiA2M10sIHJbKGQgPDwgNCAmIDQ4KSArIChoID4+PiA0ICYgMTUpXSwgZywgZyk7DQogICAgICAgIGJyZWFrOw0KICAgIGNhc2UgMjoNCiAgICAgICAgZCA9IGVbY107DQogICAgICAgIGggPSBlW2MgKyAxXTsNCiAgICAgICAgZSA9IDA7DQogICAgICAgIG0ucHVzaChyW2QgPj4+IDIgJiA2M10sIHJbKGQgPDwgNCAmIDQ4KSArIChoID4+PiA0ICYgMTUpXSwgclsoaCA8PCAyICYgNjApICsgKGUgPj4+IDYgJiAzKV0sIGcpOw0KICAgICAgICBicmVhazsNCiAgICBjYXNlIDM6DQogICAgICAgIGQgPSBlW2NdOw0KICAgICAgICBoID0gZVtjICsgMV07DQogICAgICAgIGUgPSBlW2MgKyAyXTsNCiAgICAgICAgbS5wdXNoKHJbZCA+Pj4gMiAmIDYzXSwgclsoZCA8PCA0ICYgNDgpICsgKGggPj4+IDQgJiAxNSldLCByWyhoIDw8IDIgJiA2MCkgKyAoZSA+Pj4gNiAmIDMpXSwgcltlICYgNjNdKTsNCiAgICAgICAgYnJlYWs7DQogICAgZGVmYXVsdDoNCiAgICAgICAgdGhyb3cgRXJyb3IoJzEwMTAnKTsNCiAgICB9DQogICAgcmV0dXJuIG0uam9pbignJykNCn0NCmZ1bmN0aW9uIFNiKGUsIGMsIGQpIHsNCiAgICB2b2lkIDAgPT09IGMgJiYgKGMgPSBbXSk7DQogICAgdm9pZCAwID09PSBkICYmIChkID0gZGIpOw0KICAgIGlmICghZSkNCiAgICAgICAgcmV0dXJuIG51bGw7DQogICAgaWYgKGUubGVuZ3RoID09PSAwKQ0KICAgICAgICByZXR1cm4gJyc7DQogICAgdmFyIHIgPSAzOw0KICAgIHRyeSB7DQogICAgICAgIGZvciAodmFyIGcgPSBbXSwgaCA9IDA7IGggPCBlLmxlbmd0aDsgKQ0KICAgICAgICAgICAgaWYgKGggKyByIDw9IGUubGVuZ3RoKQ0KICAgICAgICAgICAgICAgIGcucHVzaChRYihlLCBoLCByLCBjLCBkKSksDQogICAgICAgICAgICAgICAgaCArPSByOw0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgZy5wdXNoKFFiKGUsIGgsIGUubGVuZ3RoIC0gaCwgYywgZCkpOw0KICAgICAgICAgICAgICAgIGJyZWFrDQogICAgICAgICAgICB9DQogICAgICAgIHJldHVybiBnLmpvaW4oJycpDQogICAgfSBjYXRjaCAobSkgew0KICAgICAgICB0aHJvdyBFcnJvcignMTAxMCcpOw0KICAgIH0NCn0NCmZ1bmN0aW9uICRiKCkgew0KICAgIHZhciBlID0gKG5ldyBEYXRlKVsnZ2V0VGltZSddKCkNCiAgICAgICwgYyA9IE1hdGhbJ2Zsb29yJ10oZSAvIDQyOTQ5NjcyOTYpDQogICAgICAsIGQgPSBlICUgNDI5NDk2NzI5Ng0KICAgICAgLCBlID0gWChjKQ0KICAgICAgLCBkID0gWChkKQ0KICAgICAgLCBjID0gW107DQogICAgZ2EoZSwgMCwgYywgMCwgNCk7DQogICAgZ2EoZCwgMCwgYywgNCwgNCk7DQogICAgZCA9IFtdOw0KICAgIGZvciAoZSA9IDA7IGUgPCA4OyBlKyspDQogICAgICAgIGRbZV0gPSBDKE1hdGhbJ2Zsb29yJ10oTWF0aFsncmFuZG9tJ10oKSAqIDI1NikpOw0KICAgIGZvciAodmFyIGUgPSBbXSwgZyA9IDA7IGcgPCBjLmxlbmd0aCAqIDI7IGcrKykgew0KICAgICAgICBpZiAoZyAlIDIgPT0gMCkgew0KICAgICAgICAgICAgdmFyIGYgPSBnIC8gMjsNCiAgICAgICAgICAgIGVbZ10gPSBlW2ddIHwgKGRbZl0gJiAxNikgPj4+IDQgfCAoZFtmXSAmIDMyKSA+Pj4gMyB8IChkW2ZdICYgNjQpID4+PiAyIHwgKGRbZl0gJiAxMjgpID4+PiAxIHwgKGNbZl0gJiAxNikgPj4+IDMgfCAoY1tmXSAmIDMyKSA+Pj4gMiB8IChjW2ZdICYgNjQpID4+PiAxIHwgKGNbZl0gJiAxMjgpID4+PiAwDQogICAgICAgIH0gZWxzZQ0KICAgICAgICAgICAgZiA9IE1hdGhbJ2Zsb29yJ10oZyAvIDIpLA0KICAgICAgICAgICAgZVtnXSA9IGVbZ10gfCAoZFtmXSAmIDEpIDw8IDAgfCAoZFtmXSAmIDIpIDw8IDEgfCAoZFtmXSAmIDQpIDw8IDIgfCAoZFtmXSAmIDgpIDw8IDMgfCAoY1tmXSAmIDEpIDw8IDEgfCAoY1tmXSAmIDIpIDw8IDIgfCAoY1tmXSAmIDQpIDw8IDMgfCAoY1tmXSAmIDgpIDw8IDQ7DQogICAgICAgIGVbZ10gPSBDKGVbZ10pDQogICAgfQ0KICAgIGMgPSBnYihlKTsNCiAgICBjID0gWmIoWWIodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGMgKyAnZEFXc0JoQ3F0T2FOTExKMjVoQnpXYnFXWHdpSzk5V2QnKSkpKTsNCiAgICBjID0gaGIoYy5zdWJzdHJpbmcoMCwgMTYpKTsNCiAgICByZXR1cm4gVGIoYy5jb25jYXQoZSkpDQp9DQpmdW5jdGlvbiBMYihiKSB7DQogICAgaWYgKG51bGwgPT09IGIgfHwgYi5sZW5ndGggPT09IDApDQogICAgICAgIHJldHVybiBbXTsNCiAgICBiID0gdHlwZW9mIGIgPT09ICdzdHJpbmcnID8gYiA6IFN0cmluZyhiKTsNCiAgICBmb3IgKHZhciBjID0gW10sIGQgPSAwLCByID0gMCwgZyA9IGIubGVuZ3RoIC8gMjsgciA8IGc7IHIrKykgew0KICAgICAgICB2YXIgaCA9IHBhcnNlSW50KGIuY2hhckF0KGQrKyksIDE2KSA8PCA0DQogICAgICAgICAgLCBtID0gcGFyc2VJbnQoYi5jaGFyQXQoZCsrKSwgMTYpOw0KICAgICAgICBjW3JdID0gQyhoICsgbSkNCiAgICB9DQogICAgcmV0dXJuIGMNCn0NCmZ1bmN0aW9uIHlhKGUpIHsNCiAgICBpZiAobnVsbCA9PT0gZSB8fCB2b2lkIDAgPT09IGUpDQogICAgICAgIHJldHVybiBlOw0KICAgIGUgPSBlbmNvZGVVUklDb21wb25lbnQoZSk7DQogICAgZm9yICh2YXIgYyA9IFtdLCBkID0gMCwgciA9IGUubGVuZ3RoOyBkIDwgcjsgZCsrKQ0KICAgICAgICBpZiAoZS5jaGFyQXQoZCkgPT09ICclJykNCiAgICAgICAgICAgIGlmIChkICsgMiA8IHIpDQogICAgICAgICAgICAgICAgYy5wdXNoKExiKGUuY2hhckF0KCsrZCkgKyAnJyArIGUuY2hhckF0KCsrZCkpWzBdKTsNCiAgICAgICAgICAgIGVsc2UNCiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignMTAwOScpOw0KICAgICAgICBlbHNlDQogICAgICAgICAgICBjLnB1c2goQyhlLmNoYXJDb2RlQXQoZCkpKTsNCiAgICByZXR1cm4gYw0KfQ0KZnVuY3Rpb24gTGEoZSkgew0KICAgIGlmICghZSkNCiAgICAgICAgcmV0dXJuICcnOw0KICAgIHZhciBjID0gMA0KICAgICAgLCBkID0gWzMxLCAxMjUsIC0xMiwgNjAsIDMyLCA0OF07DQogICAgZSA9IHlhKGUpOw0KICAgIGZvciAodmFyIGcgPSBbXSwgcSA9IDA7IHEgPCBlLmxlbmd0aDsgcSsrKQ0KICAgICAgICBnW3FdID0gQyhlW3FdIF4gZFtjKysgJSBkLmxlbmd0aF0pLA0KICAgICAgICBnW3FdID0gQygwIC0gZ1txXSk7DQogICAgcmV0dXJuIGdiKGcpDQp9DQpmdW5jdGlvbiBiYyhhKSB7DQogICAgdmFyIGMgPSBhLkMNCiAgICAgICwgZCA9IGEua2ENCiAgICAgICwgZyA9ICd3U1Vxc3ZEZEYvQkVFUlVRQUZOdi9lcUEzU210dlY3cScNCiAgICAgICwgZiA9IDE7DQogICAgYSA9IHsNCiAgICAgICAgcjogZiwNCiAgICAgICAgZDogZyB8fCAnJywNCiAgICAgICAgYjogYw0KICAgIH07DQogICAgZCAmJiAoYyA9IGhiKFpiKFliKGFjKGVuY29kZVVSSUNvbXBvbmVudChmICsgZyArIGMgKyAnV29lVHBYbkREUGhpQXZzSlVVSVkzUmRBbzJQS2FWd2knKSkpKSksDQogICAgYS50ID0gVGIoYykpOw0KICAgIHRyeSB7DQogICAgICAgIHJldHVybiBMYShKU09OWydzdHJpbmdpZnknXShhKSkNCiAgICB9IGNhdGNoIChoKSB7DQogICAgICAgIHJldHVybiBMYSgnRVJST1InKQ0KICAgIH0NCn0NCmZ1bmN0aW9uIG1haW4oKSB7DQogICAgcmV0dXJuIGJjKHsNCiAgICAgICAgQzogJGIoKSwNCiAgICAgICAga2E6IGZhbHNlLA0KICAgIH0pDQp9DQovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCmNvbnNvbGUubG9nKG1haW4oKSk7DQo='


def aes_encrypt(text, key):
    text = text.encode()
    pad = 16 - len(text) % 16
    text += chr(pad).encode() * pad
    aes = AES.new(key.encode(), AES.MODE_CBC, '0102030405060708'.encode())
    result = aes.encrypt(text)
    return base64.b64encode(result).decode()


class Musicer(BaseMusicer):
    """docstring for Musicer."""

    URL = 'https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token='
    SEARCH_URL = 'https://music.163.com/weapi/cloudsearch/get/web?csrf_token='
    DATA = {
        'params': '',
        'encSecKey': 'ddb9e95ecba455a303a46b36f291368947d49531f824f5c4adbea2ff7ce22a2e0615a837d727ced55fdbfa85b3590466a39b85749ee5845d29786a7727fd8f154f953ca755d533fe84aa0f100c767f6dbc8441a5ad35711706cb9cf662018025a4519405aa738af496cd3d01594d62821ed0f39b4af97dee184b26e655dd4737',
    }
    i = "7qRdIQPyLJv6h2wV"
    g = "0CoJUm6Qyw8W8jud"
    INFO_REQUEST_DICT = {
        "hlpretag": "<span class=\"s-fc7\">",
        "hlposttag": "</span>",
        "s": '',
        "type": '1',
        "offset": '0',
        "total": "true",
        "limit": "30",
        "csrf_token": "",
    }
    URL_REQUEST_DICT = {
        'ids': '',
        'level': 'standard',
        'encodeType': 'aac',
        'csrf_token': '',
    }

    def __init__(self):
        super(Musicer, self).__init__(
            current_path=current_path, js=CHECKTOKEN_JS)
        self.headers['cookie'] = spare_cookie
        self.headers['referer'] = 'https://music.163.com/'
        self._login = self._update_cookie(self._login)

    def encrypt(self, text):
        text = aes_encrypt(text, self.g)
        result = aes_encrypt(text, self.i)
        return result

    async def _get_song_info(self, song):
        self._set_random_ua()
        self.INFO_REQUEST_DICT['s'] = song
        self.DATA['params'] = self.encrypt(json.dumps(self.INFO_REQUEST_DICT))
        res = await self.session.post(
            self.SEARCH_URL, headers=self.headers, data=self.DATA)
        assert (status := res.status) == 200, f'response: {status}'
        result_dict = await res.json(content_type=None)
        assert (results := result_dict.get('result')) is not None, '出现未知错误'
        songs = results['songs']
        return [SongInfo(
            f"网易云: {song['name']}-->{song['ar'][0]['name']}-->《{song['al']['name']}》",
            SongID((str(song['id']),), 'wyy'),
            os.path.split(pic_url := song['al']['picUrl'])[1],
            pic_url)
            for song in songs]

    async def _get_song_url(self, _id):
        self._set_random_ua()
        self.URL_REQUEST_DICT['ids'] = f'[{str(_id)}]'
        self.DATA['params'] = self.encrypt(json.dumps(self.URL_REQUEST_DICT))
        res = await self.session.post(self.URL, headers=self.headers, data=self.DATA)
        assert (status := res.status) == 200, f'response: {status}'
        result_dict = await res.json(content_type=None)
        assert (url := result_dict['data'][0]['url']) is not None,\
            'VIP或无版权歌曲，无法播放与下载'
        return SongUrl(url)

    async def _login(self, login_id, password, **kwargs):
        url = 'https://music.163.com/weapi/w/login/cellphone?csrf_token='
        headers = {
            'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36',
            'referer': 'http://music.163.com',
            'cookie': 'NMTID=00ObOpOnwKc7uIwCEcBp8a9bV8P-hIAAAF_PwlR5Q; _iuqxldmzr_=32; _ntes_nuid=3f95a2c40f5bd172fba6fca35d542b46; _ntes_nnid=3f95a2c40f5bd172fba6fca35d542b46,1646030075008; WNMCID=rtlosq.1646030076156.01.0; WEVNSM=1.0.0; WM_NI=R%2Fik8nwFs0YoIjC6AYktZzNMx1YjaM57rSnaIJfo1QV8NRFamMuywjte3BmX5zCAw3TCByh%2Fp9ZXt9kNxR7e6GzNU%2Bw36t14aka6fVrZlPNSCojdtXGwOldKJ4eiXY7zYnE%3D; WM_NIKE=9ca17ae2e6ffcda170e2e6ee93b154f8b9b9acaa44a1eb8bb2c45e879e8aaaf17fa9f1fab2c96aa294b8afcb2af0fea7c3b92a92f1a78cbb66b59abdd1dc658bb68dd7c453a9ac969bcd47bcef978be447f7e9beb4ed6b8b96aa90b45b96e882b3c56baf93bb9af662b8bbfda3f054f7a68da2f639989d8e9aeb25b4e796b9f733a992b8b3b66ff699b6afd821b5edfa95b440a3b5afd7e55eb286a4b1cd5981b1a685f75485a9818de7418aecab8adb53f5a6978fc837e2a3; WM_TID=DvzJL3DQwaxAVEBEVFc7%2Bh%2BvEMeeelNX; __snaker__id=KrApEbhpaWl7NueK; _9755xjdesxxd_=32; ntes_kaola_ad=1; gdxidpyhxdE=cHaGX2t0JBMIc6Iej7itrPlEse8kE%5C5%5Cy6obB1bvkboYVq%2FKHhSqOz5B3%5CugjdLmxvZ3Cj0%2BErNoXeLDuQvA0P3cYYecpe6DxXQAAsWXG8KZw4ea%5CdaMZRScKLgPwAoXSwf8oAity0K39ZlhnB4V99LT%5CNprnE1AVf%2FwxvKC1kikPq4m%3A1646033030187; JSESSIONID-WYYY=dsyCegx0x69Q%2FfKl%2BQT47iFHFfzBz5gHauRUdKfFC5CgBpqyj4bl%2BMMfPCVI%2Fg8DjHXsMIQ0hGpqqn8USFxV7XISnDphO%5CJhB%5C0G0Nsvt9jZjS22N%5C741VcXzMMirq9Eu%2BO2ZgQaM6iM6N%5CC6vh1zw9KxiuTlxmU2nHJi%2BlOD2roXcZq%3A1646033930236',
        }
        login_dict = {
            'phone': login_id,
            'rememberLogin': 'true',
            'password': hashlib.md5(password.encode()).hexdigest(),
            'checkToken': await self._get_checktoken(),
            'csrf_token': '',
        }
        self.DATA['params'] = self.encrypt(json.dumps(login_dict))
        res = await self.session.post(url, headers=headers, data=self.DATA)
        result_dict = await res.json(content_type=None)
        assert result_dict['code'] == 200, result_dict.get('msg') or '登录失败'
        return {i.key: i.value for i in res.cookies.values()}

    async def _get_checktoken(self):
        path = await self.load_js()
        asyncio.current_task().add_done_callback(
            lambda x: os.remove(path))
        return await self._run_js(path)
